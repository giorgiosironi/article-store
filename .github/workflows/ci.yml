name: CI

on: [push, pull_request]

#[10:02:05][giorgio@Newton:~/code/article-store]$ docker save -o article-store.master-dev libero/article-store:master-dev
#[10:02:35][giorgio@Newton:~/code/article-store]$ ls -l article-store.master-dev
#-rw------- 1 giorgio giorgio 213813248 Dec  3 10:02 article-store.master-dev
#[10:02:45][giorgio@Newton:~/code/article-store]$ docker load -i article-store.master-dev

env:
  IMAGE_TAG: ${{ github.sha }}

jobs:

  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v1

    - name: Build Docker images
      run: |
        set -e
        TARGET=prod make build
        TARGET=dev make build
        mkdir -p docker-images
        docker save -o docker-images/article-store libero/article-store:${IMAGE_TAG}
        docker save -o docker-images/article-store.dev libero/article-store:${IMAGE_TAG}-dev

    - name: Upload Docker image artifact
      uses: actions/upload-artifact@v1
      with:
        name: docker-images
        path: docker-images

    - name: Lint
      run: make lint
      if: always()

    - name: Test
      run: make test
      if: always()


  smoke-tests:

    needs: build
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v1

    - name: Download Docker image artifact
      uses: actions/download-artifact@v1
      with:
        name: docker-images

    - name: Prod
      run: |
        set -e
        docker load -i docker-images/article-store
        TARGET=prod .travis/smoke-test.sh

    - name: Dev
      run: |
        set -e
        docker load -i docker-images/article-store.dev
        TARGET=dev .travis/smoke-test.sh


  analyse:

    needs: build
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v1

    - name: Download Docker image artifact
      uses: actions/download-artifact@v1
      with:
        name: docker-images

    - name: Analyse
      run: |
        set -e
        ls -l docker-images
        docker load -i docker-images/article-store.dev
        .travis/analyse.sh
